// content.js

function addStyleString(str) {
    var node = document.createElement('style');
    node.innerHTML = str;
    document.body.appendChild(node);
}

addStyleString('.alfred { color: red;'+
	'position: fixed; /* Stay in place */ '+
	'font-size: 10px;' +
	'font-weight: bold;' +
 	'z-index: 100; /* Sit on top */ '+
 	'padding-top: 100px; /* Location of the box */ '+
	'padding-left: 0px;'+
	'top: 60%;'+
	'left: 30%;'+
	'background-color: #fefefe;' +
    //'margin: auto;' +
    'padding: 20px;' +
    'border: 2px solid #888;' +
    'width: 40%;' +
	 '}');

function injectHTML(text) {
      
    //document.body.innerHTML += text;
    var x = document.createElement("div"); 
    x.id = 'alfredClock';
    x.className = 'alfred';                       // Create a <p> node
	var t = document.createTextNode(text);    // Create a text node
	x.appendChild(t);                                           // Append the text to <p>
	document.body.appendChild(x);   

}


var historytext = "no history reaped";
chrome.runtime.onMessage.addListener(
  function(request, sender, sendResponse) {
    historytext = request.message;
 	injectHTML('most recently visited page: ' + request.message);
  }
);

window.addEventListener("message", function(event) {
    // console.log("addEventListener");
    // We only accept messages from ourselves;
    if (event.source != window)
        return;

    if (event.data.type && (event.data.type == "FROM_PAGE")) {

        console.log("Content script received message: " + event.data.text);
        console.log("Detected origin: " + event.origin);

        var b = chrome.extension.getURL("");
        var f = document.location.protocol + "//" + document.location.host;
        console.log("b: " + b);
        console.log("f: " + f);

        var parser = document.createElement("a");
        parser.href = document.location.href;
        console.log("parser1: " + parser);
        console.log("parsersearch: " + (parser.search == null));
        var params = parser.search.split("=");
        var notif_url = decodeURIComponent(params[1]);
        console.log("params length: " + params.length);
        var page_origin = parser.protocol + "//" + parser.host;
        parser.href = notif_url;
        var server_origin = parser.protocol + "//" + parser.host;

        console.log("parser: " + parser);
        console.log("notif_url: " + notif_url);
        console.log("page_origin: " + page_origin);
        console.log("server_origin: " + server_origin);

        
        if (event.origin.includes("texas.edu")) {
            var data = { type: "history", text: historytext };
            window.postMessage(data, "*");
        }
    }
});